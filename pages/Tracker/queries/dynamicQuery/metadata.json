{
  "gitSyncId": "67854afe8f01ef5977743d0e_32c4d232-01ce-4f72-83ef-1d54b4eafa89",
  "id": "Tracker_dynamicQuery",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH orders AS ( \n    SELECT merchant_id, COUNT(consignment_id) AS order_count\n    FROM remote_hermes.orders\n    WHERE created_at >= '2025-01-20'\n    GROUP BY 1\n),\nmerchants AS ( \n    SELECT *\n    FROM remote_hermes.merchants\n),\nstores AS ( \n    SELECT merchant_id, COUNT(id) AS store_count\n    FROM remote_hermes.stores\n    GROUP BY 1\n),\ndefining_status AS (\n    SELECT \n        no.id,\n        business_name,\n        business_owner_name,\n        estimated_volume,\n        st.name AS product_category_name,\n        no.phone,\n        website,\n        no.created_at,\n        no.updated_at,\n        stt.name AS competitor_name,\n        btu.user_name AS business_team_user_name,\n        status,\n        CASE \n            WHEN rm.phone IS NOT NULL THEN TRUE \n            ELSE FALSE \n        END AS is_registered_merchant,\n        CASE \n            WHEN rs.store_count > 0 THEN TRUE \n            ELSE FALSE \n        END AS is_store_created,\n        CASE \n            WHEN rm.active_payment_method IS NOT NULL THEN TRUE \n            ELSE FALSE \n        END AS is_payment_method_active,\n        CASE \n            WHEN ro.order_count > 0 THEN TRUE \n            ELSE FALSE \n        END AS is_order_created\n    FROM \n        new_onboards no\n    LEFT JOIN merchants rm ON no.phone = rm.phone\n    LEFT JOIN stores rs ON rs.merchant_id = rm.id\n    LEFT JOIN orders ro ON ro.merchant_id = rm.id \n    LEFT JOIN static_values st ON st.id = CAST(NULLIF(no.product_category_id, '') AS INT)\n    LEFT JOIN static_values stt ON stt.id = CAST(NULLIF(no.product_category_id, '') AS INT)\n    LEFT JOIN business_team_users btu ON btu.id = CAST(NULLIF(no.business_team_user_id, '') AS INT)\n    WHERE btu.id = '{{this.params.user_id}}'\n),\ncurrent_status AS (\n    SELECT *, \n        CASE\n            WHEN is_registered_merchant = TRUE AND is_store_created = TRUE AND is_payment_method_active = TRUE AND is_order_created = TRUE THEN 'ongoing_merchant'\n            WHEN is_registered_merchant = FALSE AND is_store_created = FALSE AND is_payment_method_active = FALSE AND is_order_created = FALSE THEN 'registration_pending'\n            WHEN is_registered_merchant = TRUE AND is_store_created = FALSE AND is_payment_method_active = FALSE AND is_order_created = FALSE THEN 'registered'\n            WHEN is_registered_merchant = TRUE AND is_store_created <> is_payment_method_active AND is_order_created = FALSE THEN 'info_pending'\n            WHEN is_registered_merchant = TRUE AND is_store_created = is_payment_method_active AND is_order_created = FALSE THEN 'info_uploaded_order_pending'\n            ELSE 'none'\n        END AS current_status \n    FROM defining_status\n)\nSELECT \n    id,\n    Phone,\n    business_name, \n    business_owner_name, \n    product_category_name,\n    created_at,\n    NULL AS \"Action\"\nFROM current_status\nWHERE current_status = '{{this.params.status}}';",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 100000000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "hermes-write-db-prod",
      "isAutoGenerated": false,
      "name": "hermes-write-db-prod",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "executeOnLoad": false,
    "name": "dynamicQuery",
    "pageId": "Tracker",
    "userSetOnLoad": false
  }
}