with orders as ( 
	select consignment_id, merchant_id
	from remote_hermes.orders
	where created_at >= '2025-01-20'
),

defining_status as (SELECT 
    no.*, 
    CASE 
        WHEN rm.phone IS NOT NULL THEN TRUE 
        ELSE FALSE 
    END AS is_registered_merchant,
		
		CASE 
        WHEN rs.merchant_id IS NOT NULL THEN TRUE 
        ELSE FALSE 
    END AS is_store_created,
		CASE 
        WHEN rm.active_payment_method IS NOT NULL THEN TRUE 
        ELSE FALSE 
    END AS is_payment_method_active,
		CASE 
        WHEN ro.merchant_id IS NOT NULL THEN TRUE 
        ELSE FALSE 
    END AS is_order_created
FROM 
    new_onboards no
LEFT JOIN 
    remote_hermes.merchants rm
ON 
    no.phone = rm.phone
LEFT JOIN 
		 remote_hermes.stores rs 
ON  
		 rs.merchant_id = rm.id
LEFT JOIN 
	  orders ro 
ON  ro.merchant_id = rm.id )

select *, 
		CASE
    WHEN is_registered_merchant = 'true' AND is_store_created = 'true' AND is_payment_method_active = 'true'  THEN 'registered_store_payment_active'
    WHEN is_registered_merchant = 'true' AND is_store_created = 'true' AND is_payment_method_active = 'false' THEN 'registered_store_only'
    WHEN is_registered_merchant = 'true' AND is_store_created = 'false' AND is_payment_method_active = 'true' THEN 'registered_payment_only'
    WHEN is_registered_merchant = 'true' AND is_store_created = 'false' AND is_payment_method_active = 'false' THEN 'only_registered'
    WHEN is_registered_merchant = 'false' AND is_store_created = 'true' AND is_payment_method_active = 'true' THEN 'store_payment_only'
    WHEN is_registered_merchant = 'false' AND is_store_created = 'true' AND is_payment_method_active = 'false' THEN 'only_store_created'
    WHEN is_registered_merchant = 'false' AND is_store_created = 'false' AND is_payment_method_active = 'true' THEN 'only_payment_method_active'
    ELSE 'null'
END as current_status

from defining_status

